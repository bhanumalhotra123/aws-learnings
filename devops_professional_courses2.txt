Infrastructure as code

  Cloud Formation
Declarative programming(no need to figure out ordering and orchestration)

 create template 
  It gives you everything in correct order

  Version control using git

Seperation of concern: Create many stacks for many apps and many layers
Ex: 
  VPC stacks
  Network stacks
  App stacks


  Each time we create ElasticBeanstalk, it creates cloudformation template behind the scenes.

Don't re-invent
    Leverage existing templates on web
    Leverage the documentation

Templates have to be uploaded in S3 and then referenced in CloudFormation.
To update a template we can't edit previous ones. We have to re-upload a new version of the template to AWS.

Stacks are identified by a name.
Deleting a stack deletes every single artifact that was created by CloudFormation


Manual way:
    Edit templates in the CloudFormation Designer.
    Using the console to input parameters, etc.
Automated way:
    Edit templates in a YAML file
    Using the AWS CLI to deploy the templates
    Recommended way when you fully want to automate your flow.



CloudFormation Building Blocks.
    Templates components 
    1. Resources: your AWS resources declared in the template(MANDATORY)
    2. Parameters: the dynamic inputs for your template
    3. Mappings: the static variables for your template
    4. Outputs: References to what has been created
    5. Conditionals: List of conditions to perform resource creation
    6. Metadata

    Template helpers:
    1. References
    2. Functions


Introductory Example:
1. Create a EC2 instance
2. Create and add and Elastic IP to it.
3. Add two security groups to it.

  
Go to cloudformation > Set N.Virginia for now.

>Create Stack > With new resources? OR With existing resoures

  > Template is ready OR Use a sample template OR Create template in Designer.

  Choose a file
  Give a stack name

  You get to review
  Create Stack 

  Under the Events tab
  You can see things are getting initiated.

  You can check on specific resource  by going to its console.
  Or you can go to resources tab and have links there.



  ---
  Resources:
    MyInstance:
      Type: AWS::EC2::Instances
      Properties:
        AvailabilityZone: us-east-1a
        ImageId: ami-a4c7edb 
        InstanceType: t2.micro



          Now assume we want to use the following template: Instead of the one mentioned above that we had used for the previous setup.

  ---
    Parameters:
      SecurityGroupDescription:
         Description: Security Group Description
         Type: String

    Resources:
      MyInstance:
      Type: AWS::EC2::Instances
      Properties:
        AvailabilityZone: us-east-1a
        ImageId: ami-a4c7edb 
        InstanceType: t2.micro
        SecurityGroups:
          - !Ref SSHSecurityGroup
          - !Ref ServerSecurityGroup

      MyEIP:
        Type: AWS::EC2::EIP
        Properties:
          InstanceId: !Ref MyInstance

      SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
          GroupDescription: Enable SSH access via port 22
          SecurityGroupIngress:
          - CidrIP: 0.0.0.0/0
            FromPort: 22
            IpProtocol: tcp
            ToPort: 22

     ServiceSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
          GroupDescription: !Ref SecurityGroupDescription
          SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 80    
            ToPort: 80
            CidrIP: 0.0.0.0/0
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: 192.168.1.1/32

Select the stack you created > Update
              Use Current template OR Replace current template OR Edit template in designer

Go for Replace current template > Upload a template         

click on next: Now you will be prompted to give the value of the parameter you had:

SecurityGroupDescription: 
Enter whatever you want and go next

Change Set Review
  It tells you the differences, like eip will be edded , instance will be modified (it shows wether it will be replaced or not) and so on.
 Next

  In events you will see update in  progress.
              
Doesn't matter whatever order you had given



What if you terminate your instance?
Other things such as security groups, elasticIPs still exist.

Instead  select your stack and delete stack so that it deletes everything.

Even the deletion happens in correct sequence
first eip
2nd instance, then 
sg

Every thing has to happen from cloudformation onky.



You can use yaml and cf

YAML Course.
JSON is horrible for CF

Key value pairs
nested objects
supported arrays
multi line string        

address:
  lines: |
      458 walkman Dr.
      suite #292
  city: pingpong



Resources are the core of your CF
224 resouces
Resource to learn them: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html



For EC2:

https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_EC2.html

EIP:
https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-eip.html




Some common questions:

Can I create dynamic amout of resources?

No, you can't. Everything in the CF template has to be declared. You can't perform code genertation there.

Is every AWS Service Supported?
Almost. Only few select few niches are not there yet.
You can work around that  using aws lambda custom resources.




       


What are parameters?

Parameters are a way to provide inputs to your AWS CloudFormation template

They are imp to know about if:
  You want to reuse your templates across the company
  Some inputs can not be determined ahead of time.

Parameters are extremely powerful, controlled and can prevent errors


ASK yourself:
 Is this CloudFormation resource config likely to change in the future?
 If so, make it a paramter.

Parameters can be controlled by all these settings:

Type:
    String
    Number
    CommaDelimitedList
    List<Type>
    AWS Parameter(to help catch invalid values - match against existing values in the AWS Account)
Description
Constraints
ConstraintDescription
Min/MaxLength
Min/Max Value
Defaults
AllowedValues(array)
AllowedPattern(regexp)
NoEcho(Boolean)



How do you Reference a Parameter?
The Fn::Ref function can be leveraged to reference parameters
Parameters can be used anywhere in a template.
The shorthand for this in YAML is !Ref

DSubnet1:
  Type: AWS::EC2::Subnet
  Properties:
    VpcId: !Ref MyVPC


Pseudo Parameters
AWS offers us pseudo parameters in any CloudFormation template
These can be used at any time and are enabled by default.

AWS:AccountId
AWS:NotificationARNs
AWS:NoValue
AWS:Region
AWS:StackId
AWS:StackName




What are mappings?

Mappings are fixed variables within your CloudFormation Template
They're very handy to differentiate b/w diff envs, regions, AMI types etc
Example:

Mappings:
  Mapping01:
    Key01:
      Name: Value01
    Key02:
      Name: Value02
    Key03: 
      Name: Value03

RegionMaps:
  us-east-1:
    "32": "ami-6411e20d"
    "64": "ami-7a11e213"
  us-west-1:
     "32": "ami-c9c7978c"
     "64": "ami-cfc7978a"


Mapping VS Parameters

M: When you know all values in advance
such as Region, AZ, AWS Account, env, etc...

They allow safer control over the template.


Use parameters when the values are really user specific.



Accessing maping values:
We use Fn::FindMap to return a named value from a specific key.

!FindInMap [ MapName, TopLevelKey, SecondLevelKey ]

  

AWSTemplateFormatVersion: "2010-09-09"
Mappings:
  RegionMaps:
  us-east-1:
    "32": "ami-6411e20d"
    "64": "ami-7a11e213"
  us-west-1:
     "32": "ami-c9c7978c"
     "64": "ami-cfc7978a"
Resources:
  myEC2Instance:
    Type: "AWS::EC2::Instance"
    Properties:
    ImageId: !FindMap [RegionMap, !Ref "AWS::Region", 32]





What are outputs?
The outputs section declares optional outputs values that we can import into other stacks(if you export them first)!

You can also view the outputs in  the AWS Console or in using the AWS CLI
They're very useful for example if you define a network CloudFormation, and output the variables such as VPC ID and your Subnet IDs.

It is the best way to perform collaboration cross stack, as you let expert handle their own part of the stack.


You can't delete a CloudFormation Stack if its outputs are being referenced by another CloudFormation Stack.


Example:

Outputs:
  StackSSHSecurityGroup:
  Description: The SSH Security Group for our Company
  Value: !Ref MyCompanyWideSSHSecurityGroup
  Export: 
    Name: SSHSecurityGroup           #the StackSSHSecurityGroup will be exported with the name SSHSecurityGroup


We then create a second template that leverages that security group.
For this we use the Fn::ImportValue function
You can't delete the underlying stack until all references are delted too.


     Resources:
      MyInstance:
      Type: AWS::EC2::Instances
      Properties:
        AvailabilityZone: us-east-1a
        ImageId: ami-a4c7edb 
        InstanceType: t2.micro
        SecurityGroups:
          - !ImportValue SSHSecurityGroup





What are conditions used for?



